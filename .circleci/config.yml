# DO NOT MODIFY - this is managed by Git Reduce in goro and generated from build-matrix.json
#
---
version: 2
jobs:
  generate-and-push-docs:
    docker: []
    steps:
    - checkout
    - run: bundle config stitchfix01.jfrog.io $ARTIFACTORY_USER:$ARTIFACTORY_TOKEN
    - run: bundle install
    - run:
        name: Generate documentation
        command: ' if [[ $(bundle exec rake -T docs:generate:custom) ]]; then echo
          "Generating docs using rake task docs:generate:custom" ; bundle exec rake
          docs:generate:custom ; elif [[ $(bundle exec rake -T docs:generate) ]];
          then echo "Generating docs using rake task docs:generate" ; bundle exec
          rake docs:generate ; else echo "Skipping doc generation" ; exit 0 ; fi '
    - run:
        name: Push documentation to Unwritten
        command: if [[ $(bundle exec rake -T docs:push) ]]; then bundle exec rake
          docs:push; fi
  release:
    docker: []
    steps:
    - checkout
    - run: bundle config stitchfix01.jfrog.io $ARTIFACTORY_USER:$ARTIFACTORY_TOKEN
    - run: bundle install
    - run:
        name: Artifactory login
        command: mkdir -p ~/.gem && curl -u$ARTIFACTORY_USER:$ARTIFACTORY_TOKEN https://stitchfix01.jfrog.io/stitchfix01/api/gems/eng-gems/api/v1/api_key.yaml
          > ~/.gem/credentials && chmod 0600 ~/.gem/credentials
    - run:
        name: Build/release gem to artifactory
        command: bundle exec rake push_artifactory
workflows:
  version: 2
  on-commit:
    jobs:
    - release:
        context: org-global
        requires: []
        filters:
          tags:
            only: /^[0-9]+\.[0-9]+\.[0-9]+((-|\.)?(RC|rc)[-\.]?\w*)?$/
          branches:
            ignore: /.*/
    - generate-and-push-docs:
        context: org-global
        requires:
        - release
        filters:
          tags:
            only: /^[0-9]+\.[0-9]+\.[0-9]+((-|\.)?(RC|rc)[-\.]?\w*)?$/
          branches:
            ignore: /.*/
  scheduled:
    triggers:
    - schedule:
        cron: 53 20 * * 1,2,3,4,5
        filters:
          branches:
            only:
            - main
    jobs: []
